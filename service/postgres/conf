#!/bin/sh

exec 2>&1
realpath "$0"
set -ex
cat >>"$PGDATA/postgresql.conf" <<EOF

cluster_name = '$CLUSTER_NAME'
listen_addresses = '*'
max_logical_replication_workers = 0
max_sync_workers_per_subscription = 0
max_wal_senders = 0
wal_level = minimal
EOF

if [ -z "$PG_AUTO_FAILOVER" ] && [ -d /etc/certs ]; then
    cat >>"$PGDATA/postgresql.conf" <<EOF

ssl_ca_file = '/etc/certs/ca.pem'
ssl_cert_file = '/etc/certs/cert.pem'
ssl_key_file = '/etc/certs/key.pem'
ssl = on
EOF
    if [ -f /etc/certs/crl.pem ]; then
        cat >>"$PGDATA/postgresql.conf" <<EOF

ssl_crl_file = '/etc/certs/crl.pem'
EOF
    fi
fi
