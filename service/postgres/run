#!/bin/sh

exec 2>&1
install -d -m 0750 -o "$USER" -g "$GROUP" "$PGDATA"
install -d -m 1775 -o "$USER" -g "$GROUP" /run/postgresql /var/log/postgresql
#touch "$HOME/gfs/primary"
#chown "$USER":"$GROUP" "$HOME/gfs/primary"
rm -f /run/postgresql/postgres.run
#test -f /run/postgresql/pg_auto_failover.run || exit $?
realpath "$0"
set -ex
chmod 755 supervise
chown "$USER":"$GROUP" supervise/ok supervise/control supervise/status
#rm -f "$PGDATA/postmaster.pid"
#if [ -z "$PG_AUTO_FAILOVER_MONITOR" ]; then
#    chpst -u "$USER":"$GROUP" pg_autoctl -vvv create monitor --nodename "$(hostname)" --no-ssl --auth trust
#else
#    chpst -u "$USER":"$GROUP" pg_autoctl -vvv create postgres --nodename "$(hostname)" --no-ssl --auth trust --allow-removing-pgdata --monitor="$PG_AUTO_FAILOVER_MONITOR"
#fi
#case "$PG_AUTO_FAILOVER_MONITOR" in
#    monitor)
#        chpst -u "$USER":"$GROUP" pg_autoctl -vvv create monitor --nodename "$(hostname)" --no-ssl --auth trust
#    ;;
#    *)
#        chpst -u "$USER":"$GROUP" pg_autoctl -vvv create postgres --nodename "$(hostname)" --no-ssl --auth trust --allow-removing-pgdata --monitor=postgres://autoctl_node@tasks.monitor:5432/pg_auto_failover
#    ;;
#esac
#primary="$(cat "$HOME/gfs/primary")"
#test -n "$primary" || echo -n "$(hostname)" >"$HOME/gfs/primary"
#primary="$(cat "$HOME/gfs/primary")"
#test -n "$primary"
#if [ "$primary" != "$(hostname)" ] && chpst -u "$USER":"$GROUP" pg_isready --host="$primary" --port=5432 --username=postgres --dbname=postgres --timeout=10; then
#    echo exists
#else
#    echo -n "$(hostname)" >"$HOME/gfs/primary"
#    primary="$(cat "$HOME/gfs/primary")"
#    test -n "$primary"
#fi
#if [ "$primary" != "$(hostname)" ]; then
#    test -d "$PGDATA/base" || /etc/service/postgres/standby
#    test -f "$PGDATA/standby.signal" || /etc/service/postgres/rejoin
#else
#    test -d "$PGDATA/base" || /etc/service/postgres/primary
#fi
#test -d "$PGDATA/base" || /etc/service/postgres/init
#test -d "$PGDATA/base"
#exec chpst -u "$USER":"$GROUP" -L /run/postgresql/postgres.run postmaster
